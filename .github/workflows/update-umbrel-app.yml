# Update Umbrel App
# =================
# This workflow updates the Umbrel app definition when a new image is built.
# It:
# - Syncs fork with upstream getumbrel/umbrel-apps
# - Updates ONLY safe fields (image, version, releaseNotes)
# - Runs umbrel-cli lint before committing
# - Opens/updates a PR to the upstream repository
# - Waits for the Lint apps check to pass

name: Update Umbrel App

on:
  # Triggered by build-image workflow
  repository_dispatch:
    types: [new-image]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., v2026.1.24)'
        required: true
      digest:
        description: 'Image digest (sha256:...)'
        required: true
      image:
        description: 'Image name (without tag/digest)'
        required: false
        default: 'ghcr.io/harmalh/clawdbot-umbrel'
      skip_lint:
        description: 'Skip local lint check'
        required: false
        default: false
        type: boolean
      skip_pr_wait:
        description: 'Skip waiting for PR checks'
        required: false
        default: false
        type: boolean

env:
  UMBREL_APPS_REPO: getumbrel/umbrel-apps
  APP_ID: clawdbot
  NODE_VERSION: '20'

jobs:
  update-app:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
    steps:
      - name: Check out this repository
        uses: actions/checkout@v4
        with:
          path: clawdbot-umbrel

      - name: Parse event payload
        id: payload
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "digest=${{ github.event.client_payload.digest }}" >> $GITHUB_OUTPUT
            echo "image=${{ github.event.client_payload.image }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "digest=${{ github.event.inputs.digest }}" >> $GITHUB_OUTPUT
            echo "image=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch upstream release notes
        id: release_notes
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          
          echo "Fetching release notes for $VERSION from upstream Clawdbot..."
          
          # Fetch release info from GitHub API
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/clawdbot/clawdbot/releases/tags/${VERSION}" || echo "{}")
          
          # Extract release body (the release notes)
          RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body // empty' | head -100)
          RELEASE_NAME=$(echo "$RELEASE_JSON" | jq -r '.name // empty')
          RELEASE_URL=$(echo "$RELEASE_JSON" | jq -r '.html_url // empty')
          RELEASE_DATE=$(echo "$RELEASE_JSON" | jq -r '.published_at // empty' | cut -d'T' -f1)
          
          if [[ -z "$RELEASE_BODY" || "$RELEASE_BODY" == "null" ]]; then
            echo "No release notes found, using default message"
            RELEASE_BODY="No release notes available for this version."
          fi
          
          # Store in outputs (escape for GitHub Actions)
          # Use a delimiter for multiline output
          {
            echo "body<<EOF"
            echo "$RELEASE_BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "url=${RELEASE_URL}" >> $GITHUB_OUTPUT
          echo "date=${RELEASE_DATE}" >> $GITHUB_OUTPUT
          
          echo "âœ… Fetched release notes for $VERSION"

      - name: Validate inputs
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          DIGEST="${{ steps.payload.outputs.digest }}"
          
          # Validate version is non-empty
          if [[ -z "$VERSION" ]]; then
            echo "::error::Version is required"
            exit 1
          fi
          
          # Validate digest format (must be sha256:...)
          if [[ ! "$DIGEST" =~ ^sha256:[a-f0-9]{64}$ ]]; then
            echo "::error::Invalid digest format. Expected sha256:... but got: $DIGEST"
            exit 1
          fi
          
          echo "âœ… Inputs validated: version=$VERSION, digest=$DIGEST"

      - name: Fork umbrel-apps (if not exists)
        env:
          GH_TOKEN: ${{ secrets.UMBREL_APPS_PAT }}
        run: |
          # Check if fork exists
          FORK_EXISTS=$(gh api repos/${{ github.repository_owner }}/umbrel-apps --jq '.id' 2>/dev/null || echo "")
          
          if [[ -z "$FORK_EXISTS" ]]; then
            echo "Creating fork of umbrel-apps..."
            gh repo fork ${{ env.UMBREL_APPS_REPO }} --clone=false
            sleep 10  # Wait for fork to be ready
          else
            echo "âœ… Fork already exists"
          fi

      - name: Check out umbrel-apps fork
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/umbrel-apps
          token: ${{ secrets.UMBREL_APPS_PAT }}
          path: umbrel-apps
          fetch-depth: 0  # Full history for rebasing

      - name: Sync fork with upstream
        working-directory: umbrel-apps
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add upstream remote
          git remote add upstream https://github.com/${{ env.UMBREL_APPS_REPO }}.git || true
          
          # Fetch upstream
          echo "Fetching upstream..."
          git fetch upstream master
          
          # Update local master to match upstream
          git checkout master
          git reset --hard upstream/master
          git push origin master --force-with-lease || git push origin master --force
          
          echo "âœ… Fork synced with upstream"

      - name: Check if app exists in upstream (new submission vs update)
        id: check_upstream
        working-directory: umbrel-apps
        run: |
          # Check if the app already exists in upstream master
          # This determines if this is a new submission or an update
          if git ls-tree -r upstream/master --name-only | grep -q "^${{ env.APP_ID }}/"; then
            echo "App exists in upstream - this is an UPDATE"
            echo "is_update=true" >> $GITHUB_OUTPUT
          else
            echo "App does not exist in upstream - this is a NEW SUBMISSION"
            echo "is_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update branch
        id: branch
        working-directory: umbrel-apps
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          IS_UPDATE="${{ steps.check_upstream.outputs.is_update }}"
          
          # Determine branch name based on submission status
          if [[ "$IS_UPDATE" == "true" ]]; then
            # App already exists upstream - use version-specific branch for update PRs
            BRANCH="update-clawdbot-${VERSION}"
            echo "Using version-specific branch for update: $BRANCH"
          else
            # New submission - use fixed branch so all updates go to same PR until merged
            BRANCH="add-clawdbot"
            echo "Using fixed branch for new submission: $BRANCH"
          fi
          
          # Check if branch already exists on remote
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH exists, rebasing onto upstream/master..."
            git checkout "$BRANCH"
            git rebase upstream/master || {
              echo "::warning::Rebase failed, resetting branch to upstream/master"
              git rebase --abort || true
              git reset --hard upstream/master
            }
          else
            echo "Creating new branch $BRANCH from upstream/master..."
            git checkout -b "$BRANCH" upstream/master
          fi
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Ensure app directory exists
        run: |
          if [[ ! -d "umbrel-apps/${{ env.APP_ID }}" ]]; then
            echo "App directory doesn't exist, copying from this repo..."
            cp -r clawdbot-umbrel/umbrel-app/${{ env.APP_ID }} umbrel-apps/
          fi

      - name: Update docker-compose.yml (image only)
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          DIGEST="${{ steps.payload.outputs.digest }}"
          IMAGE="${{ steps.payload.outputs.image }}"
          
          COMPOSE_FILE="umbrel-apps/${{ env.APP_ID }}/docker-compose.yml"
          
          # Backup original
          cp "$COMPOSE_FILE" "${COMPOSE_FILE}.bak"
          
          # Only update the image line in the gateway service
          # This preserves all other configuration (environment, volumes, etc.)
          # Pattern: find lines with 'image:' and replace the value
          # The sed matches any image reference and replaces with the new pinned image
          
          # Use yq for precise YAML editing if available, otherwise sed
          if command -v yq &> /dev/null; then
            yq -i ".services.gateway.image = \"${IMAGE}:${VERSION}@${DIGEST}\"" "$COMPOSE_FILE"
          else
            # Fallback: sed-based replacement (matches image line in gateway section)
            sed -i "s|^\([[:space:]]*image:[[:space:]]*\).*|\1${IMAGE}:${VERSION}@${DIGEST}|" "$COMPOSE_FILE"
          fi
          
          # Verify the update worked
          if ! grep -q "@${DIGEST}" "$COMPOSE_FILE"; then
            echo "::error::Failed to update docker-compose.yml with new digest"
            echo "Current file:"
            cat "$COMPOSE_FILE"
            mv "${COMPOSE_FILE}.bak" "$COMPOSE_FILE"
            exit 1
          fi
          
          echo "âœ… Updated docker-compose.yml:"
          grep "image:" "$COMPOSE_FILE"
          
          rm -f "${COMPOSE_FILE}.bak"

      - name: Update umbrel-app.yml (version and releaseNotes only)
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          IS_UPDATE="${{ steps.check_upstream.outputs.is_update }}"
          APP_FILE="umbrel-apps/${{ env.APP_ID }}/umbrel-app.yml"
          
          # Remove 'v' prefix for version field
          CLEAN_VERSION="${VERSION#v}"
          DATE=$(date +%Y-%m-%d)
          
          # Backup original
          cp "$APP_FILE" "${APP_FILE}.bak"
          
          # Update ONLY version - preserve everything else
          sed -i "s|^version:.*|version: \"${CLEAN_VERSION}\"|" "$APP_FILE"
          
          # Only set releaseNotes for UPDATES (not new submissions)
          # Umbrel requires releaseNotes to be empty for new submissions
          if [[ "$IS_UPDATE" == "true" ]]; then
            sed -i "s|^releaseNotes:.*|releaseNotes: \"Updated to Clawdbot ${VERSION} (${DATE})\"|" "$APP_FILE"
            echo "âœ… Set releaseNotes for update"
          else
            # Ensure releaseNotes is empty for new submissions
            sed -i "s|^releaseNotes:.*|releaseNotes: \"\"|" "$APP_FILE"
            echo "âœ… Kept releaseNotes empty for new submission"
          fi
          
          echo "âœ… Updated umbrel-app.yml:"
          grep -E "^version:|^releaseNotes:" "$APP_FILE"
          
          rm -f "${APP_FILE}.bak"

      - name: Verify only safe files changed
        working-directory: umbrel-apps
        run: |
          # Check what files have been modified
          CHANGED_FILES=$(git diff --name-only)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Verify only allowed files are changed
          ALLOWED_FILES="${{ env.APP_ID }}/docker-compose.yml
          ${{ env.APP_ID }}/umbrel-app.yml"
          
          for file in $CHANGED_FILES; do
            if ! echo "$ALLOWED_FILES" | grep -qF "$file"; then
              echo "::error::Unexpected file changed: $file"
              echo "Only docker-compose.yml and umbrel-app.yml should be modified."
              git diff "$file"
              exit 1
            fi
          done
          
          echo "âœ… Only safe files modified"

      - name: Setup Node.js for linting
        if: github.event.inputs.skip_lint != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and run umbrel-cli lint
        if: github.event.inputs.skip_lint != 'true'
        working-directory: umbrel-apps
        run: |
          echo "Installing umbrel-cli..."
          npm install -g umbrel-cli@^0.6.4
          
          echo "Running lint on ${{ env.APP_ID }}..."
          umbrel lint ${{ env.APP_ID }}
          
          echo "âœ… Lint passed"

      - name: Commit changes
        working-directory: umbrel-apps
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          BRANCH="${{ steps.branch.outputs.branch }}"
          
          git add .
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update Clawdbot to ${VERSION}" -m "Automated update from clawdbot-umbrel CI

          Changes:
          - Updated Docker image to ${VERSION} with digest pinning
          - Updated app version in umbrel-app.yml"

      - name: Push changes
        working-directory: umbrel-apps
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          
          # Try regular push first (for new branches)
          if ! git push origin "$BRANCH" 2>/dev/null; then
            # If it fails, use --force-with-lease (safer than --force)
            echo "Regular push failed, using --force-with-lease..."
            git push origin "$BRANCH" --force-with-lease
          fi
          
          echo "âœ… Pushed to origin/$BRANCH"

      - name: Create or update PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.UMBREL_APPS_PAT }}
          RELEASE_NOTES: ${{ steps.release_notes.outputs.body }}
          RELEASE_URL: ${{ steps.release_notes.outputs.url }}
          RELEASE_DATE: ${{ steps.release_notes.outputs.date }}
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          DIGEST="${{ steps.payload.outputs.digest }}"
          BRANCH="${{ steps.branch.outputs.branch }}"
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --repo ${{ env.UMBREL_APPS_REPO }} \
            --head "${{ github.repository_owner }}:${BRANCH}" \
            --json number,url --jq '.[0]' 2>/dev/null || echo "")
          
          if [[ -n "$EXISTING_PR" && "$EXISTING_PR" != "null" ]]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
            echo "PR #${PR_NUMBER} already exists: $PR_URL"
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          else
            # Build release notes section
            RELEASE_SECTION=""
            if [[ -n "$RELEASE_URL" && "$RELEASE_URL" != "null" ]]; then
              RELEASE_SECTION="## Upstream Release Notes ([${VERSION}](${RELEASE_URL}))

          ${RELEASE_NOTES}

          "
            fi
            
            # Create PR with upstream release notes
            PR_URL=$(gh pr create \
              --repo ${{ env.UMBREL_APPS_REPO }} \
              --head "${{ github.repository_owner }}:${BRANCH}" \
              --base master \
              --title "Update Clawdbot to ${VERSION}" \
              --body "## Summary

          This PR updates the Clawdbot app to version ${VERSION}.

          ${RELEASE_SECTION}## Changes

          - Updated Docker image to \`${VERSION}\` with digest pinning
          - Updated app version in umbrel-app.yml
          - Image digest: \`${DIGEST}\`

          ---

          *Automated PR from [clawdbot-umbrel](https://github.com/${{ github.repository }})*")
            
            PR_NUMBER=$(gh pr view --repo ${{ env.UMBREL_APPS_REPO }} "$PR_URL" --json number --jq '.number')
            echo "Created PR #${PR_NUMBER}: $PR_URL"
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          fi

  wait-for-checks:
    needs: update-app
    if: github.event.inputs.skip_pr_wait != 'true' && needs.update-app.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Wait for PR checks
        env:
          GH_TOKEN: ${{ secrets.UMBREL_APPS_PAT }}
          PR_NUMBER: ${{ needs.update-app.outputs.pr_number }}
        run: |
          echo "Waiting for checks on PR #${PR_NUMBER}..."
          
          # Wait for checks with a timeout (10 minutes)
          TIMEOUT=600
          INTERVAL=30
          ELAPSED=0
          
          while [[ $ELAPSED -lt $TIMEOUT ]]; do
            # Get check status
            CHECKS=$(gh pr checks --repo ${{ env.UMBREL_APPS_REPO }} "$PR_NUMBER" 2>/dev/null || echo "")
            
            if [[ -z "$CHECKS" ]]; then
              echo "No checks found yet, waiting..."
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
              continue
            fi
            
            echo "$CHECKS"
            
            # Check if all checks passed
            if echo "$CHECKS" | grep -q "fail\|failure"; then
              echo "::error::One or more checks failed!"
              exit 1
            fi
            
            if echo "$CHECKS" | grep -q "pending\|queued\|in_progress"; then
              echo "Checks still running, waiting..."
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
              continue
            fi
            
            # All checks passed
            echo "âœ… All checks passed!"
            exit 0
          done
          
          echo "::warning::Timeout waiting for checks. Please verify manually."
          exit 0

      - name: Summary
        env:
          PR_URL: ${{ needs.update-app.outputs.pr_url }}
          PR_NUMBER: ${{ needs.update-app.outputs.pr_number }}
        run: |
          echo "## ðŸŽ‰ Umbrel App Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** [#${PR_NUMBER}](${PR_URL})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The PR has been created/updated and checks have passed." >> $GITHUB_STEP_SUMMARY
